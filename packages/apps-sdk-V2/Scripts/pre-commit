#!/bin/sh
set -e

FILE="Sources/SDK/TheSDK.swift"

# Current branch
#BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Extract current version string (whatever is inside the quotes)
VERSION=$(grep 'static let version' "$FILE" | sed -E 's/.*"([^"]*)".*/\1/')

# Handle empty version string ("")
if [ -z "$VERSION" ]; then
  MAJOR=1
  MINOR=0
  PATCH=0
else
  # Check if version matches the expected format vX.Y.Z
  if ! echo "$VERSION" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
    echo "❌ Error: Version '$VERSION' is not in the required format vX.Y.Z (e.g., v1.0.0)"
    echo "Please update the version in $FILE to match the format before committing."
    exit 1
  fi
  
  # Extract major, minor, and patch numbers from version
  MAJOR=$(echo "$VERSION" | sed -E 's/^v([0-9]+)\.[0-9]+\.[0-9]+$/\1/')
  MINOR=$(echo "$VERSION" | sed -E 's/^v[0-9]+\.([0-9]+)\.[0-9]+$/\1/')
  PATCH=$(echo "$VERSION" | sed -E 's/^v[0-9]+\.[0-9]+\.([0-9]+)$/\1/')
fi

# Reset if branch changed
# if [ "$CUR_BRANCH" != "$BRANCH" ]; then
#   NUMBER=0
# fi

# Increment patch version
NEW_PATCH=$((PATCH + 1))
NEW_VERSION="v$MAJOR.$MINOR.$NEW_PATCH"

# Replace in file
sed -i '' -E "s/static let version = \".*\"/static let version = \"$NEW_VERSION\"/" "$FILE"

# Stage updated file
git add "$FILE"

# Create tag only if it doesn't exist
if ! git rev-parse "$NEW_VERSION" >/dev/null 2>&1; then
  git tag "$NEW_VERSION"
  echo "✅ Updated version: \"$VERSION\" → \"$NEW_VERSION\" (tag created)"
else
  echo "✅ Updated version: \"$VERSION\" → \"$NEW_VERSION\" (tag already exists)"
fi